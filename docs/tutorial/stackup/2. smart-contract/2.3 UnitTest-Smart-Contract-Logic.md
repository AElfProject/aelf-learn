---
sidebar_position: 3
---

# Unit Test Voting Smart Contract Logic

It is advice to create a Unit Text for the Smart Contract before it is deployed to the Aelf blockchain. The Unit Test not just help us to verify the Smart Contract is free from bugs, it is also gives us the opportunity to review our code before it is deployed.

In this step, we will be writing the unit test of our Voting Smart Contract in the **test/BuildersDAOTests.cs** file!

Proceed to overwrite the existing contents of **test/BuildersDAOTests.cs** file with the following code snippet.

## Implementing Unit Test for Initialize

```csharp showLineNumbers
[Fact]
public async Task InitializeTest_Success()
{
    // The Initialize method is to initialize the Smart Contract
    var res = await BuildersDAOStub.Initialize.SendAsync(new Empty());
    // The result should be Mined
    res.TransactionResult.Status.ToString().ShouldBe("Mined");
}

[Fact]
public async Task InitializeTest_Duplicate()
{
    // The Initialize method is to initialize the Smart Contract
    await BuildersDAOStub.Initialize.SendAsync(new Empty());
    try
    {
        // If repeated call Initialize method, it will throw an exception
        await BuildersDAOStub.Initialize.SendAsync(new Empty());
    }
    catch (Exception e)
    {
        e.Message.ShouldContain("already initialized");
    }
}
```

## Implementing Unit Test for JoinDAO

```csharp showLineNumbers
[Fact]
public async Task JoinDAOTest_Success()
{
    // Mock the Initialize step
    await InitializeTest_Success();
    // After we have initialized the BuildsDAO smart contract, we simulate two participants by calling the JoinDAO methods two times with two different accounts
    var res1 = await BuildersDAOStub.JoinDAO.SendAsync(Accounts[1].Address);
    var res2 = await BuildersDAOStub.JoinDAO.SendAsync(Accounts[2].Address);
    // The result should be Mined
    res1.TransactionResult.Status.ToString().ShouldBe("Mined");
    res2.TransactionResult.Status.ToString().ShouldBe("Mined");
}

[Fact]
public async Task JoinDAOTest_Duplicate()
{
    // Mock the Initialize step
    await InitializeTest_Success();
    await BuildersDAOStub.JoinDAO.SendAsync(Accounts[1].Address);
    try
    {
        // If repeated call JoinDAO method with the same account, it will throw an exception
        await BuildersDAOStub.JoinDAO.SendAsync(Accounts[1].Address);
    }
    catch (Exception e)
    {
        e.Message.ShouldContain("Member is already in the DAO");
    }
}
```

## Implementing Unit Test for CreateProposal

```csharp showLineNumbers
[Fact]
public async Task CreateProposalTest_Success()
{
    // Mock the Initialize, JoinDAO steps
    await JoinDAOTest_Success();
    // Creates a proposal with the first account.
    var proposal = await CreateProposal(Accounts[1].Address);
    // The result should be the same as input
    proposal.Title.ShouldBe("proposal test");
}

private async Task<Proposal> CreateProposal(Address creator)
{
    var createProposalInput = new CreateProposalInput
    {
        Creator = creator,
        Description = "proposal test",
        Title = "proposal test",
        VoteThreshold = 1
    };
    var proposal = await BuildersDAOStub.CreateProposal.SendAsync(createProposalInput);
    return proposal.Output;
}

[Fact]
public async Task CreateProposalTest_NoPermission()
{
    // Mock the Initialize, JoinDAO steps
    await JoinDAOTest_Success();
    try
    {
        // If call CreateProposal method without the first account, it will throw an exception
        await CreateProposal(Accounts[2].Address);
    }
    catch (Exception e)
    {
        e.Message.ShouldContain("Only DAO members can create proposals");
    }
}
```

## Implementing Unit Test for VoteOnProposal

```csharp showLineNumbers
[Fact]
public async Task VoteOnProposalTest_Success()
{
    // Mock the Initialize, JoinDAO steps
    await JoinDAOTest_Success();
    // Mock the CreateProposal step
    var proposal = await CreateProposal(Accounts[1].Address);
    // Vote the created proposal with the two accounts.
    var voteInput1 = new VoteInput
    {
        ProposalId = proposal.Id,
        Vote = true,
        Voter = Accounts[1].Address
    };
    // The result should be Mined
    var res1 = await BuildersDAOStub.VoteOnProposal.SendAsync(voteInput1);
    var voteInput2 = new VoteInput
    {
        ProposalId = proposal.Id,
        Vote = false,
        Voter = Accounts[2].Address
    };
    var res2 = await BuildersDAOStub.VoteOnProposal.SendAsync(voteInput2);
    res1.TransactionResult.Status.ToString().ShouldBe("Mined");
    res2.TransactionResult.Status.ToString().ShouldBe("Mined");
}

[Fact]
public async Task VoteOnProposalTest_NoPermission()
{
    // Mock the Initialize, JoinDAO steps
    await JoinDAOTest_Success();
    // Mock the CreateProposal step
    var proposal = await CreateProposal(Accounts[1].Address);
    var voteInput1 = new VoteInput
    {
        ProposalId = proposal.Id,
        Vote = true,
        Voter = Accounts[3].Address
    };
    try
    {
        // If call VoteOnProposal method with an account who does not have called JoinDAO, it will throw an exception
        await BuildersDAOStub.VoteOnProposal.SendAsync(voteInput1);
    }
    catch (Exception e)
    {
        e.Message.ShouldContain("Only DAO members can vote");
    }
}

[Fact]
public async Task VoteOnProposalTest_NoProposal()
{
    // Mock the Initialize, JoinDAO steps
    await JoinDAOTest_Success();
    // Mock the CreateProposal step
    var proposal = await CreateProposal(Accounts[1].Address);
    var voteInput1 = new VoteInput
    {
        ProposalId = "123",
        Vote = true,
        Voter = Accounts[1].Address
    };
    try
    {
        // If call VoteOnProposal method with a ProposalId that does not have called CreateProposal, it will throw an exception
        await BuildersDAOStub.VoteOnProposal.SendAsync(voteInput1);
    }
    catch (Exception e)
    {
        e.Message.ShouldContain("Proposal not found");
    }
}
```

## Implementing Unit Test for GetAllProposals

```csharp showLineNumbers
[Fact]
public async Task GetAllProposalsTest()
{
    // Mock the Initialize, JoinDAO, CreateProposal, VoteOnProposal steps
    await VoteOnProposalTest_Success();
    // Gets all the proposals
    var proposalResult = await BuildersDAOStub.GetAllProposals.CallAsync(new Empty());
    // The result should be same as input
    proposalResult.Proposals[1].YesVotes.ShouldContain(Accounts[1].Address);
    proposalResult.Proposals[1].NoVotes.ShouldContain(Accounts[2].Address);
}
```

After that, run ``dotnet test`` command to execute this unit test case, and check the result.

You should see the following output from terminal:

![result](/img/unit-test-output.png)


**Understanding the Code**

In these code snippet, we run the unit test in sequence.

We will then verify the steps with the **ShouldBe, ShouldContain** SDK methods with expected outcomes of the Unit Test.